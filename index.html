<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empréstimo de Livros</title>
</head>
<body>
    <h1>Registro de Empréstimo</h1>
    
    <form id="emprestimoForm">
        <label for="nomeUsuario">Nome do Usuário:</label>
        <input type="text" id="nomeUsuario" required><br>

        <label for="turma">Turma:</label>
        <input type="text" id="turma" required><br>

        <label for="telefone">Telefone:</label>
        <input type="text" id="telefone" required><br>

        <label for="periodo">Período:</label>
        <input type="text" id="periodo" required><br>

        <label for="livroId">ID do Livro:</label>
        <input type="number" id="livroId" required><br>

        <label for="dataEmprestimo">Data do Empréstimo:</label>
        <input type="date" id="dataEmprestimo" required><br>

        <label for="dataDevolucao">Data de Devolução:</label>
        <input type="date" id="dataDevolucao" required><br>

        <button type="button" onclick="registrarEmprestimo()">Registrar Empréstimo</button>
    </form>

    <script>
        async function registrarEmprestimo() {
            const nomeUsuario = document.getElementById("nomeUsuario").value;
            const turma = document.getElementById("turma").value;
            const telefone = document.getElementById("telefone").value;
            const periodo = document.getElementById("periodo").value;
            const livroId = document.getElementById("livroId").value;
            const dataEmprestimo = document.getElementById("dataEmprestimo").value;
            const dataDevolucao = document.getElementById("dataDevolucao").value;

            try {
                const usuarioResponse = await fetch('/verificarUsuario', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ nomeUsuario, turma, telefone, periodo })
                });
                
                const usuarioData = await usuarioResponse.json();

                let usuarioId = usuarioData.usuarioId;

                // EXPLICAÇÃO DA FUNCTION ACIMA:
                // fetch() é uma função nativa do JavaScript usada para fazer requisições HTTP para um servidor.
                // Ele suporta vários tipos de métodos HTTP, como GET, POST, PUT, DELETE, etc.
                // No caso desse código, o fetch() está sendo usado para enviar dados ao servidor.

                // O método POST é utilizado para enviar dados ao servidor.
                // Ele difere do método GET, que é usado apenas para recuperar informações.
                // No exemplo: O POST é usado para enviar os dados do usuário (nomeUsuario, turma, etc.)
                // ao servidor para verificar se o usuário já existe.
                 
                // /verificarUsuario é uma rota no servidor.
                // Essa rota foi criada no backend no JS do app.js

                // O cabeçalho (headers) contém informações sobre a requisição. Ele pode incluir:
                // O tipo de dados sendo enviado (por exemplo, JSON).
                // Informações de autenticação, tokens, cookies, entre outros.
                // Content-Type: application/json informa ao servidor que os dados no corpo da requisição estão no formato JSON.

                // JSON.stringify() transforma o objeto JavaScript { nomeUsuario, turma, telefone, periodo } em uma string JSON.
                // Isso é necessário porque o fetch() envia dados em formato de texto para o servidor.

                // usuarioResponse é o objeto retornado pelo fetch().
                // Ele contém informações sobre a resposta do servidor, como:
                // O status HTTP (200, 404, 500, etc.).
                // Os dados enviados pelo servidor.

                // O método .json() é usado para extrair o conteúdo da resposta em formato JSON.
                // O servidor (no backend) retorna um JSON com o ID do usuário.
                // Ao chamar .json() em usuarioResponse, transformamos essa resposta em um objeto JavaScript:
                // const usuarioData = await usuarioResponse.json();

                // Se o servidor respondeu com { "usuarioId": 42 }, então:
                // usuarioId será 42.
                // Se o servidor respondeu com { "usuarioId": null }, então:
                // usuarioId será null, indicando que o usuário não existe.

                if (!usuarioId) {
                    const novoUsuarioResponse = await fetch('/registrarUsuario', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ nomeUsuario, turma, telefone, periodo })
                    });
                    const novoUsuarioData = await novoUsuarioResponse.json();
                    usuarioId = novoUsuarioData.usuarioId;
                }

                const emprestimoResponse = await fetch('/registrarEmprestimo', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        usuarioId, livroId, dataEmprestimo, dataDevolucao, status: "Em Aberto"
                    })
                });

                if (emprestimoResponse.ok) {
                    alert("Empréstimo registrado com sucesso!");
                } else {
                    alert("Erro ao registrar empréstimo.");
                }
            } catch (error) {
                console.error("Erro:", error);
                alert("Erro ao conectar ao sistema.");
            }
        }
    </script>
</body>
</html>
